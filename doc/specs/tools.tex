\chapter{Programs}
\label{sec:tools}

\section{Environment Variables}
\label{sec:tools:envvars}

There is a number of environment variables that alter the behavior of
the \urbi tools.

\subsection{Search Path Variables}

Some variables define \dfn[search-path]{search-paths}, i.e.,
colon-separated lists of directories in which library files (\us
programs, UObjects and so forth) are looked for.

The tools have predefined values for these variables which are
tailored for your installation --- so that \urbi tools can be run
without any special adjustment.  In order to provide the user with a
means to override or extend these built-in values, the path variables
support a special syntax: a lone colon specifies where the standard
search path must be inserted.  See the following examples about
\env{URBI\_PATH}.

\begin{shell}
# Completely override the system path.  First look for files in
# /home/jessie/urbi, then in /usr/local/urbi.
export URBI_PATH=/home/jessie/urbi:/usr/local/urbi

# Prepend the previous path to the default path.  This is dangerous as
# it may result in some standard files being hidden.
export URBI_PATH=/home/jessie/urbi:/usr/local/urbi:

# First look in Jessie's directory, then the default location, and
# finally in /usr/local/urbi.
export URBI_PATH=/home/jessie/urbi::/usr/local/urbi

# Extend the default path, i.e., files that are not found in the
# default path will be looked for in Jessie's place, and then in
# /usr/local/urbi
export URBI_PATH=:/home/jessie/urbi:/usr/local/urbi
\end{shell}

\subsection{Environment Variables}
\begin{envs}
\item[URBI\_PATH] The search-path for \us source files.
\item[URBI\_UOBJECT\_PATH] The search-path for UObjects files.
  This is used by \command{urbi-launch}, by
  \lstinline|System.loadModule| and \lstinline|System.loadLibrary|.
\end{envs}

\section{Special Files}
\label{sec:tools:files}

\begin{files}
\item[global.u] If found in the \env{URBI\_PATH} (see
  \autoref{sec:tools:envvars}), this file is loaded by \urbi server upon
  start-up.  It is the appropriate place to install features you
  mean to provide to all the users of the server.  It is will be
  loaded via a special system connection, with its own private lobby.
  Therefore, purely local definitions will not be reachable from
  users; global modifications should be made in globally visible
  objects, say \refObject{Global}.

\item[URBI.INI] This is the obsolete name for \file{global.u}.

\item[local.u] If found in the \env{URBI\_PATH} (see
  \autoref{sec:tools:envvars}), this file is loaded by every
  connection established with an \urbi server.  This is the
  appropriate place for enhancements local to a lobby.

\item[CLIENT.INI] This is the obsolete name for \file{global.u}.
\end{files}

\section{\command{urbi} --- Running an Urbi Server}
\label{sec:tools:urbi}

The \command{urbi} program launches an \urbi server, for either batch,
interactive, or network-based executions.  It is subsumed by, but
simpler to use than, \command{urbi-launch}
(\autoref{sec:tools:urbi-launch}).

\subsection{Options}

\paragraph{Tuning}
\begin{options}
\item[-s, --stack-size=\var{size}] set the coroutine \dfn{stack size}.
  The unit of \var{size} is KB; it defaults to 128.

  This option should not be needed unless you have ``stack exhausted''
  messages from \command{urbi} in which case you should try
  \option{--stack-size=512} or more.

  Alternatively you can define the environment variable
  \env{URBI\_STACK\_SIZE}.  The option \option{--stack-size} has
  precedence over the \env{URBI\_STACK\_SIZE}.
\end{options}

\paragraph{Networking}
\begin{options}
\item[-H, --host=\var{address}] Set the \var{address} on which network
  connections are listened to.  Typical values of \var{address}
  include:
  \begin{description}
  \item[localhost] only local connections are allowed (no other
    computer can reach this server).
  \item[127.0.0.1] same as \code{localhost}.
  \item[0.0.0.0] any IP v4 connection is allowed, including from
    remote computers.
  \end{description}
  Defaults to \code{0.0.0.0}.
\item[-P, --port=\var{port}] Set the port to listen incoming
  connections to.  If \var{port} is \code{-1}, no networking.  If
  \var{port} is \code{0}, then the system will chose any available
  port (see \option{--port-file}).  Defaults to \code{-1}.
\item[-w, --port-file=\var{file}] When the system is up and running,
  and when it is ready for network connections, create the file named
  \var{file} which contains the number of the port the server listens
  to.
\end{options}


\paragraph{Execution}
\begin{options}
\item[-e, --expression=\var{exp}] send the \us expression \var{exp}.
  No separator is added, you have to pass yours.
\item[-f, --file=\var{file}] send the contents of the file \var{file}.
  No separator is added, you have to pass yours.
\item[-i, --interactive] start an interactive session.
\end{options}

The options \option{-e}, \option{-f} accumulate, and are run in the
same \refObject{Lobby} as \option{-i} if used.  In other words, the
following session is valid:

\begin{shell}[alsolanguage={[interactive]Urbi}]
# Create a file "two.u".
$ echo "var two = 2;" >two.u
# urbi -e 'var one = 1;' -f two.u -i
[00000000] 1
[00000000] 2
one + two;
[00000000] 3
\end{shell}%$

\section{\command{urbi-launch} --- Running a UObject}
\label{sec:tools:urbi-launch}

The \command{urbi-launch} program launches an \urbi system.  It is
more general than \command{urbi} (\autoref{sec:tools:urbi}):
everything \command{urbi} can do, \command{urbi-launch} can do it too.

\subsection{Invoking \command{urbi-launch}}

\command{urbi-launch} launches UObjects, either in plugged-in mode, or
in remote mode.  Since UObjects can also accept options, the command
line features two parts, separated by \samp{--}:

\begin{shell}
urbi-launch [\var{urbi-launch-option}...] \var{module}... [-- \var{module-option}...]
\end{shell}

The \var{module}s are looked for in the \env{URBI\_UOBJECT\_PATH}.

\paragraph{Urbi-launch options}
\begin{options}
\item[-h, --help] display the help message and exit successfully.
\item[--version] display version information and exit successfully.
\item[-c, --customize=\var{file}] start the \urbi server in
  \var{file}.  This option is mostly for developpers.
\item[-d, --debug=\var{level}] Set the verbosity level of traces.
  This option is mostly for developpers, but it is very useful when
  tracking problems such as a UObject that fails to load properly.
  Valid values for \var{level} are, in increasing verbosity order:
  \begin{enumerate}
  \item \code{NONE}, no log messages at all.
  \item \code{LOG}, the default value.
  \item \code{TRACE}
  \item \code{DEBUG}
  \item \code{DUMP}, maximum verbosity.
  \end{enumerate}
\end{options}

\paragraph{Mode selection}
\begin{options}
\item[-p, --plugin] attach the \var{module} onto a currently running
  \urbi server (identified by \var{host} and \var{port}).  This is
  equivalent to running \lstinline|loadModule("\var{module}")| on the
  corresponding server.

\item[-r, --remote] run the \var{modules} as separated processes,
  connected to a running Urbi server (identified by \var{host} and
  \var{port}) via network connection.

\item[-s, --start] Start an Urbi server with plugged-in
  \var{modules}.  In this case, the \var{module-option} are exactly
  the options supported by \command{urbi}.
\end{options}

\paragraph{Networking}
\command{urbi-launch} supports the same networking options
(\option{--host}, \option{--port}, \option{--port-file}) as
\command{urbi}, see \autoref{sec:tools:urbi}.

\subsection{Examples}

To launch a fresh server in an interactive session with the
\lstinline|UFactory| UObject compiled as the file \file{factory.so}
(or \file{factory.dll} plugged in, run:

\begin{shell}
urbi-launch --start ufactory -- --interactive
\end{shell}

To start an \urbi server accepting connections on the local port 54000
from any remote host, with \lstinline|UFactory| plugged in, run:

\begin{shell}
urbi-launch --start --host 0.0.0.0 --port 54000 ufactory
\end{shell}


\section{\command{urbi-send} --- Sending \us Commands to a Server}
\label{sec:tools:urbi-send}

\begin{shell}
urbi-send \var{option}...
\end{shell}

Connect to an \urbi server, and send commands or file contents to it.
Stay connected, until server disconnection, or user interuption (such
as \key{C-c} under a Unix terminal).

\begin{options}
\item[-b, --banner] do not hide the server-sent banner.
\item[-e, --expression=\var{script}] send \var{script} to the server.
\item[-f, --file=\var{file}] send the contents of \var{file} to the
  server.
\item[-h, --help] display this message and exit successfully.
\item[-H, --host=\var{host}] address to listen to.
\item[-P, --port=\var{port}] port to listen to, 0 for automatic
  selection.
\item[--port-file=\var{file}] file containing the port to listen to.
\item[-q, --quit] disconnect from the server immediately after having
  sent all the commands.  This is equivalent to \samp{-e 'quit;'}.
  This is inappropriate if code running in background is expected to
  deliver its result asynchronously: the connection will be closed
  before the result was sent.

  Without this option, \command{urbi-send} prompts the user to hit
  \key{C-c} to end the connection.
\item[--version] display version information
\end{options}


\section{\command{umake} --- Compiling UObject Components}
\label{sec:tools:umake}

The \command{umake} programs builds loadable modules, UObjects, to be
later run using \command{urbi-launch}
(autoref{sec:tools:urbi-launch}).  Using it is not mandatory: users
familiar with their compilation tools will probably prefer using them
directly.  Yet \command{umake} makes things more uniform and simpler,
at the cost of less control.

\subsection{Invoking \command{umake}}
\label{sec:tools:umake:invoke}

Usage:
\begin{shell}
umake \var{option}... \var{file}...
\end{shell}

Compile the \var{file}.  The \var{files} can be of different kinds:
\begin{itemize}
\item objects files (\file{*.o}, \file{*.obj} and so forth) and linked
  into the result.
\item libraries (\file{*.a}) and linked into the result.
\item source files (\file{*.cc}, \file{*.cpp}, \file{*.c}, \file{*.C})
  are compiled.
\item header files (\file{*.h}, \file{*.hh}, \file{*.hxx},
  \file{*.hpp}) are \emph{not} compiled, but used as dependencies: if
  a header file is changed, the next \command{umake} run will actually
  recompile.
\item directories are recursively traversed, and files of the above
  types are gathered as if they were given on the command line.
\end{itemize}

\paragraph{General options}
\begin{options}
\item[-D, --debug] turn on shell debugging (\lstinline|set -x|) to
  track \command{umake} problems.
\item[-h, --help] display this help message and exit successfully.
\item[-q, --quiet] no output unless errors.
\item[-v, --version] display version information and exit successfully.
\item[-V, --verbose] report on what is done.
\end{options}

\paragraph{Compilation options}
\begin{options}
\item[--deep-clean] remove all building directories and exit.
\item[-c, --clean] clean building directory before compilation.
\item[-j, --jobs=\var{jobs}] specify the numbers of compilation
  commands to run simultaneously.
\item[-l, --library] produce a library, don't link to a particular
  core.
\item[-s, --shared-library] produce a shared library loadable by any
  core.
\item[-o, --output=\var{output}] output file name.
\item[-C, --core=\var{core}] build type.
\item[-H, --host=\var{host}] destination host.
\item[-m, --disable-automain] do not add the \lstinline|main| function.
\end{options}

\paragraph{Developper options}
\begin{options}
\item[-p, --prefix=\var{dir}] library file location
\item[-P, --param-mk=\var{file}] param.mk location
\item[-k, --kernel=\var{dir}] kernel location
\end{options}


\subsection{\command{umake} Wrappers}
\label{sec:tools:umake:wrappers}

As a convenience for common \command{umake} usages, some wrappers are
provided:
\begin{description}
\item[\command{umake-deepclean}] --- Cleaning\\
  Clean the temporary files made by running \command{umake} with the
  same arguments.  Same as \samp{umake --deep-clean}.
\item[\command{umake-shared}] --- Compiling Shared UObjects\\
  Build a shared object to be later run using \command{urbi-launch}
  (autoref{sec:tools:urbi-launch}).  Same as \samp{umake
    --shared-library}.
\end{description}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "urbi-specs"
%%% End:
